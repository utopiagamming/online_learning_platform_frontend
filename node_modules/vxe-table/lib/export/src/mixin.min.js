"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.saveLocalFile=saveLocalFile,exports.handlePrint=handlePrint,exports.default=void 0;var _ctor=_interopRequireDefault(require("xe-utils/ctor")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var htmlCellElem,fileForm,fileInput,printFrame,defaultHtmlStyle='body{margin:0;color:#333333;font-size:14px;font-family:"Microsoft YaHei",微软雅黑,"MicrosoftJhengHei",华文细黑,STHeiti,MingLiu}body *{-webkit-box-sizing:border-box;box-sizing:border-box}.vxe-table{border-collapse:collapse;text-align:left;border-spacing:0}.vxe-table:not(.is--print){table-layout:fixed}.vxe-table,.vxe-table th,.vxe-table td,.vxe-table td{border-color:#D0D0D0;border-style:solid;border-width:0}.vxe-table.is--print{width:100%}.border--default,.border--full,.border--outer{border-top-width:1px}.border--default,.border--full,.border--outer{border-left-width:1px}.border--outer,.border--default th,.border--default td,.border--full th,.border--full td,.border--outer th,.border--inner th,.border--inner td{border-bottom-width:1px}.border--default,.border--outer,.border--full th,.border--full td{border-right-width:1px}.border--default th,.border--full th,.border--outer th{background-color:#f8f8f9}.vxe-table td>div,.vxe-table th>div{padding:.5em .4em}.col--center{text-align:center}.col--right{text-align:right}.vxe-table:not(.is--print) .col--ellipsis>div{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;word-break:break-all}.vxe-table--tree-node{text-align:left}.vxe-table--tree-node-wrapper{position:relative}.vxe-table--tree-icon-wrapper{position:absolute;top:50%;width:1em;height:1em;text-align:center;-webkit-transform:translateY(-50%);transform:translateY(-50%);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:pointer}.vxe-table--tree-unfold-icon,.vxe-table--tree-fold-icon{position:absolute;width:0;height:0;border-style:solid;border-width:.5em;border-right-color:transparent;border-bottom-color:transparent}.vxe-table--tree-unfold-icon{left:.3em;top:0;border-left-color:#939599;border-top-color:transparent}.vxe-table--tree-fold-icon{left:0;top:.3em;border-left-color:transparent;border-top-color:#939599}.vxe-table--tree-cell{display:block;padding-left:1.5em}.vxe-table input[type="checkbox"]{margin:0}.vxe-table input[type="checkbox"],.vxe-table input[type="radio"],.vxe-table input[type="checkbox"]+span,.vxe-table input[type="radio"]+span{vertical-align:middle;padding-left:0.4em}',csvBOM="\ufeff",enterSymbol="\r\n";function createFrame(){var e=document.createElement("iframe");return e.className="vxe-table--print-frame",e}function getExportBlobByContent(e,t){return window.Blob?new Blob([e],{type:"text/".concat(t.type)}):null}function hasTreeChildren(e,t){var o=e.treeOpts;return t[o.children]&&t[o.children].length}function getSeq(e,t,o,r,n){var a=e.seqOpts,l=a.seqMethod||r.seqMethod||r.indexMethod;return l?l({row:t,rowIndex:o,column:r,columnIndex:n}):(a.startIndex||e.startIndex)+o+1}function defaultFilterExportColumn(e){return e.property||-1<["seq","index","checkbox","selection","radio"].indexOf(e.type)}function toTableBorder(e){return!0===e?"full":e||"default"}function toBooleanValue(e){return _ctor.default.isBoolean(e)?e?"TRUE":"FALSE":e}function getLabelData(s,d,n,e){var t=s.treeConfig,o=s.treeOpts,u=s.radioOpts,p=s.checkboxOpts;if(htmlCellElem||(htmlCellElem=document.createElement("div")),t){var a=[];return _ctor.default.eachTree(e,function(l,i,e,t,o,r){var c={_level:r.length-1,_hasChild:hasTreeChildren(s,l)};n.forEach(function(e,t){var o="",r=e.editRender||e.cellRender,n=e.exportMethod;if(!n&&r&&r.name){var a=_vXETable.default.renderer.get(r.name);a&&(n=a.exportMethod||a.cellExportMethod)}if(n)o=n({$table:s,row:l,column:e,options:d});else switch(e.type){case"seq":case"index":o=getSeq(s,l,i,e,t);break;case"selection":case"checkbox":o=toBooleanValue(s.isCheckedByCheckboxRow(l)),c._checkboxLabel=p.labelField?_ctor.default.get(l,p.labelField):"",c._checkboxDisabled=p.checkMethod&&!p.checkMethod({row:l});break;case"radio":o=toBooleanValue(s.isCheckedByRadioRow(l)),c._radioLabel=u.labelField?_ctor.default.get(l,u.labelField):"",c._radioDisabled=u.checkMethod&&!u.checkMethod({row:l});break;default:d.original?o=_tools.UtilTools.getCellValue(l,e):(o=s.getCellLabel(l,e),"html"===e.type&&(htmlCellElem.innerHTML=o,o=htmlCellElem.innerText.trim()))}c[e.id]=_ctor.default.toString(o)}),a.push(Object.assign(c,l))},o),a}return e.map(function(l,i){var c={};return n.forEach(function(e,t){var o="",r=e.editRender||e.cellRender,n=e.exportMethod;if(!n&&r&&r.name){var a=_vXETable.default.renderer.get(r.name);a&&(n=a.exportMethod||a.cellExportMethod)}if(n)o=n({$table:s,row:l,column:e,options:d});else switch(e.type){case"seq":case"index":o=getSeq(s,l,i,e,t);break;case"selection":case"checkbox":o=toBooleanValue(s.isCheckedByCheckboxRow(l)),c._checkboxLabel=p.labelField?_ctor.default.get(l,p.labelField):"",c._checkboxDisabled=p.checkMethod&&!p.checkMethod({row:l});break;case"radio":o=toBooleanValue(s.isCheckedByRadioRow(l)),c._radioLabel=u.labelField?_ctor.default.get(l,u.labelField):"",c._radioDisabled=u.checkMethod&&!u.checkMethod({row:l});break;default:d.original?o=_tools.UtilTools.getCellValue(l,e):(o=s.getCellLabel(l,e),"html"===e.type&&(htmlCellElem.innerHTML=o,o=htmlCellElem.innerText.trim()))}c[e.id]=_ctor.default.toString(o)}),c})}function getExportData(e,t){var o=t.columnFilterMethod,r=t.dataFilterMethod,n=t.columns,a=t.data;return o&&(n=n.filter(function(e,t){return o({column:e,$columnIndex:t})})),r&&(a=a.filter(function(e,t){return r({row:e,$rowIndex:t})})),{columns:n,datas:getLabelData(e,t,n,a)}}function getBooleanValue(e){return"TRUE"===e||"true"===e||!0===e}function getHeaderTitle(e,t){return(e.original?t.property:t.getTitle())||""}function getFooterCellValue(e,t,o,r){var n=r.editRender||r.cellRender,a=r.footerExportMethod;if(!a&&n&&n.name){var l=_vXETable.default.renderer.get(n.name);l&&(a=l.footerExportMethod||l.footerCellExportMethod)}var i=e.getVTColumnIndex(r);return a?a({$table:e,items:o,itemIndex:i,_columnIndex:i,column:r,options:t}):_ctor.default.toString(o[i])}function getFooterData(e,t){var o=e.footerFilterMethod;return o?t.filter(function(e,t){return o({items:e,$rowIndex:t})}):t}function toCsv(o,r,e,t){var n=csvBOM;if(r.isHeader&&(n+=e.map(function(e){return'"'.concat(getHeaderTitle(r,e),'"')}).join(",")+enterSymbol),t.forEach(function(t){n+=e.map(function(e){return'"'.concat(t[e.id],'"')}).join(",")+enterSymbol}),r.isFooter){var a=o.footerTableData;getFooterData(r,a).forEach(function(t){n+=e.map(function(e){return'"'.concat(getFooterCellValue(o,r,t,e),'"')}).join(",")+enterSymbol})}return n}function toTxt(o,r,e,t){var n="";if(r.isHeader&&(n+=e.map(function(e){return"".concat(getHeaderTitle(r,e))}).join("\t")+enterSymbol),t.forEach(function(t){n+=e.map(function(e){return"".concat(t[e.id])}).join("\t")+enterSymbol}),r.isFooter){var a=o.footerTableData;getFooterData(r,a).forEach(function(t){n+=e.map(function(e){return"".concat(getFooterCellValue(o,r,t,e))}).join(",")+enterSymbol})}return n}function hasEllipsis(e,t,o,r){var n=t[o],a=_ctor.default.isUndefined(n)||_ctor.default.isNull(n)?r:n,l="title"===a||(!0===a||"tooltip"===a)||"ellipsis"===a;return!e.scrollXLoad&&!e.scrollYLoad||l||(l=!0),l}function createHtmlPage(e,t){var o=e.style;return["<!DOCTYPE html><html>","<head>",'<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui">',"<title>".concat(e.sheetName,"</title>"),"<style>".concat(defaultHtmlStyle,"</style>"),o?"<style>".concat(o,"</style>"):"","</head>","<body>".concat(_ctor.default.toString(t),"</body>"),"</html>"].join("")}function toHtml(l,a,e,t){var i=l.id,o=l.border,r=l.treeConfig,c=l.treeOpts,n=l.isAllSelected,s=l.isIndeterminate,d=l.headerAlign,u=l.align,p=l.footerAlign,f=l.showOverflow,m=l.showHeaderOverflow,h=a.print,b=a.isHeader,v=a.isFooter,x="check-all",g=["vxe-table","border--".concat(toTableBorder(o)),h?"is--print":"",b?"show--head":""].filter(function(e){return e}),y=['<table class="'.concat(g.join(" "),'" border="0" cellspacing="0" cellpadding="0">'),"<colgroup>".concat(e.map(function(e){return'<col style="width:'.concat(e.renderWidth,'px">')}).join(""),"</colgroup>")].join("");if(b&&(y+="<thead><tr>".concat(e.map(function(e){var t=e.headerAlign||e.align||d||u,o=hasEllipsis(l,e,"showHeaderOverflow",m)?["col--ellipsis"]:[],r=getHeaderTitle(a,e);return t&&o.push("col--".concat(t)),"checkbox"===e.type||"selection"===e.type?'<th class="'.concat(o.join(" "),'"><div ').concat(h?"":'style="width: '.concat(e.renderWidth,'px"'),'><input type="checkbox" class="').concat(x,'" ').concat(n?"checked":"","><span>").concat(r,"</span></div></th>"):'<th class="'.concat(o.join(" "),'" title="').concat(r,'"><div ').concat(h?"":'style="width: '.concat(e.renderWidth,'px"'),"><span>").concat(_tools.UtilTools.formatText(r,!0),"</span></div></th>")}).join(""),"</tr></thead>")),t.length&&(y+="<tbody>",r?t.forEach(function(a){y+="<tr>"+e.map(function(e){var t=e.align||u,o=hasEllipsis(l,e,"showOverflow",f)?["col--ellipsis"]:[],r=a[e.id];if(t&&o.push("col--".concat(t)),e.treeNode){var n="";return a._hasChild&&(n='<i class="'.concat(a._expand?"vxe-table--tree-fold-icon":"vxe-table--tree-unfold-icon",'"></i>')),o.push("vxe-table--tree-node"),"radio"===e.type?'<td class="'.concat(o.join(" "),'" title="').concat(r,'"><div ').concat(h?"":'style="width: '.concat(e.renderWidth,'px"'),'><div class="vxe-table--tree-node-wrapper" style="padding-left: ').concat(a._level*c.indent,'px"><div class="vxe-table--tree-icon-wrapper">').concat(n,'</div><div class="vxe-table--tree-cell"><input type="radio" name="radio_').concat(i,'" ').concat(a._radioDisabled?"disabled ":"").concat(getBooleanValue(r)?"checked":"","><span>").concat(a._radioLabel,"</span></div></div></div></td>"):"checkbox"===e.type||"selection"===e.type?'<td class="'.concat(o.join(" "),'" title="').concat(r,'"><div ').concat(h?"":'style="width: '.concat(e.renderWidth,'px"'),'><div class="vxe-table--tree-node-wrapper" style="padding-left: ').concat(a._level*c.indent,'px"><div class="vxe-table--tree-icon-wrapper">').concat(n,'</div><div class="vxe-table--tree-cell"><input type="checkbox" ').concat(a._checkboxDisabled?"disabled ":"").concat(getBooleanValue(r)?"checked":"","><span>").concat(a._checkboxLabel,"</span></div></div></div></td>"):'<td class="'.concat(o.join(" "),'" title="').concat(r,'"><div ').concat(h?"":'style="width: '.concat(e.renderWidth,'px"'),'><div class="vxe-table--tree-node-wrapper" style="padding-left: ').concat(a._level*c.indent,'px"><div class="vxe-table--tree-icon-wrapper">').concat(n,'</div><div class="vxe-table--tree-cell">').concat(r,"</div></div></div></td>")}return"radio"===e.type?'<td class="'.concat(o.join(" "),'"><div ').concat(h?"":'style="width: '.concat(e.renderWidth,'px"'),'><input type="radio" name="radio_').concat(i,'" ').concat(a._radioDisabled?"disabled ":"").concat(getBooleanValue(r)?"checked":"","><span>").concat(a._radioLabel,"</span></div></td>"):"checkbox"===e.type||"selection"===e.type?'<td class="'.concat(o.join(" "),'"><div ').concat(h?"":'style="width: '.concat(e.renderWidth,'px"'),'><input type="checkbox" ').concat(a._checkboxDisabled?"disabled ":"").concat(getBooleanValue(r)?"checked":"","><span>").concat(a._checkboxLabel,"</span></div></td>"):'<td class="'.concat(o.join(" "),'" title="').concat(r,'"><div ').concat(h?"":'style="width: '.concat(e.renderWidth,'px"'),">").concat(_tools.UtilTools.formatText(r,!0),"</div></td>")}).join("")+"</tr>"}):t.forEach(function(n){y+="<tr>"+e.map(function(e){var t=e.align||u,o=hasEllipsis(l,e,"showOverflow",f)?["col--ellipsis"]:[],r=n[e.id];return t&&o.push("col--".concat(t)),"radio"===e.type?'<td class="'.concat(o.join(" "),'"><div ').concat(h?"":'style="width: '.concat(e.renderWidth,'px"'),'><input type="radio" name="radio_').concat(i,'" ').concat(n._radioDisabled?"disabled ":"").concat(getBooleanValue(r)?"checked":"","><span>").concat(n._radioLabel,"</span></div></td>"):"checkbox"===e.type||"selection"===e.type?'<td class="'.concat(o.join(" "),'"><div ').concat(h?"":'style="width: '.concat(e.renderWidth,'px"'),'><input type="checkbox" ').concat(n._checkboxDisabled?"disabled ":"").concat(getBooleanValue(r)?"checked":"","><span>").concat(n._checkboxLabel,"</span></div></td>"):'<td class="'.concat(o.join(" "),'" title="').concat(r,'"><div ').concat(h?"":'style="width: '.concat(e.renderWidth,'px"'),">").concat(_tools.UtilTools.formatText(r,!0),"</div></td>")}).join("")+"</tr>"}),y+="</tbody>"),v){var _=l.footerTableData,w=getFooterData(a,_);w.length&&(y+="<tfoot>",w.forEach(function(n){y+="<tr>".concat(e.map(function(e){var t=e.footerAlign||e.align||p||u,o=hasEllipsis(l,e,"showOverflow",f)?["col--ellipsis"]:[],r=getFooterCellValue(l,a,n,e);return t&&o.push("col--".concat(t)),'<td class="'.concat(o.join(" "),'" title="').concat(r,'"><div ').concat(h?"":'style="width: '.concat(e.renderWidth,'px"'),">").concat(_tools.UtilTools.formatText(r,!0),"</div></td>")}).join(""),"</tr>")}),y+="</tfoot>")}var T=!n&&s?'<script>(function(){var a=document.querySelector(".'.concat(x,'");if(a){a.indeterminate=true}})()<\/script>'):"";return y+="</table>"+T,h?y:createHtmlPage(a,y)}function toXML(o,r,e,t){var n=['<?xml version="1.0"?>','<?mso-application progid="Excel.Sheet"?>','<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">','<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">',"<Version>16.00</Version>","</DocumentProperties>",'<ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">',"<WindowHeight>7920</WindowHeight>","<WindowWidth>21570</WindowWidth>","<WindowTopX>32767</WindowTopX>","<WindowTopY>32767</WindowTopY>","<ProtectStructure>False</ProtectStructure>","<ProtectWindows>False</ProtectWindows>","</ExcelWorkbook>",'<Worksheet ss:Name="'.concat(r.sheetName,'">'),"<Table>",e.map(function(e){return'<Column ss:Width="'.concat(e.renderWidth,'"/>')}).join("")].join("");if(r.isHeader&&(n+="<Row>".concat(e.map(function(e){return'<Cell><Data ss:Type="String">'.concat(getHeaderTitle(r,e),"</Data></Cell>")}).join(""),"</Row>")),t.forEach(function(t){n+="<Row>"+e.map(function(e){return'<Cell><Data ss:Type="String">'.concat(t[e.id],"</Data></Cell>")}).join("")+"</Row>"}),r.isFooter){var a=o.footerTableData;getFooterData(r,a).forEach(function(t){n+="<Row>".concat(e.map(function(e){return'<Cell><Data ss:Type="String">'.concat(getFooterCellValue(o,r,t,e),"</Data></Cell>")}).join(""),"</Row>")})}return"".concat(n,"</Table></Worksheet></Workbook>")}function getContent(e,t,o,r){if(o.length)switch(t.type){case"csv":return toCsv(e,t,o,r);case"txt":return toTxt(e,t,o,r);case"html":return toHtml(e,t,o,r);case"xml":return toXML(e,t,o,r)}return""}function saveLocalFile(e){var t=e.filename,o=e.type,r=e.content,n="".concat(t,".").concat(o);if(window.Blob){var a=r instanceof Blob?r:getExportBlobByContent(_ctor.default.toString(r),e);if(navigator.msSaveBlob)navigator.msSaveBlob(a,n);else{var l=document.createElement("a");l.target="_blank",l.download=n,l.href=URL.createObjectURL(a),document.body.appendChild(l),l.click(),document.body.removeChild(l)}return Promise.resolve()}return Promise.reject(new Error(_tools.UtilTools.getLog("vxe.error.notExp")))}function downloadFile(e,t,o){var r=t.filename,n=t.type;if(!t.download){var a=getExportBlobByContent(o,t);return Promise.resolve({type:n,content:o,blob:a})}saveLocalFile({filename:r,type:n,content:o}).then(function(){!1!==t.message&&_vXETable.default.modal.message({message:_conf.default.i18n("vxe.table.expSuccess"),status:"success"})})}function handleExport(e,t){if(t.remote){var o={options:t,$table:e,$grid:e.$xegrid};return t.exportMethod?t.exportMethod(o):Promise.resolve(o)}var r=getExportData(e,t),n=r.columns,a=r.datas;return Promise.resolve(e.preventEvent(null,"event.export",{options:t,columns:n,datas:a},function(){return downloadFile(e,t,getContent(e,t,n,a))}))}function getElementsByTagName(e,t){return e.getElementsByTagName(t)}function replaceDoubleQuotation(e){return e.replace(/^"/,"").replace(/"$/,"")}function parseCsv(e,t){var o=t.split(enterSymbol),r=[],n=[];if(o.length){var a=o.slice(1);n=o[0].split(",").map(replaceDoubleQuotation),a.forEach(function(e){if(e){var o={};e.split(",").forEach(function(e,t){n[t]&&(o[n[t]]=replaceDoubleQuotation(e))}),r.push(o)}})}return{fields:n,rows:r}}function parseTxt(e,t){var o=t.split("\n"),r=[],n=[];if(o.length){var a=o.slice(1);n=o[0].split("\t"),a.forEach(function(e){if(e){var o={};e.split("\t").forEach(function(e,t){n[t]&&(o[n[t]]=replaceDoubleQuotation(e))}),r.push(o)}})}return{fields:n,rows:r}}function parseHTML(e,t){var o=getElementsByTagName((new DOMParser).parseFromString(t,"text/html"),"body"),r=[],n=[];if(o.length){var a=getElementsByTagName(o[0],"table");if(a.length){var l=getElementsByTagName(a[0],"thead");if(l.length){_ctor.default.arrayEach(getElementsByTagName(l[0],"tr"),function(e){_ctor.default.arrayEach(getElementsByTagName(e,"th"),function(e){n.push(e.textContent)})});var i=getElementsByTagName(a[0],"tbody");i.length&&_ctor.default.arrayEach(getElementsByTagName(i[0],"tr"),function(e){var o={};_ctor.default.arrayEach(getElementsByTagName(e,"td"),function(e,t){n[t]&&(o[n[t]]=e.textContent||"")}),r.push(o)})}}}return{fields:n,rows:r}}function parseXML(e,t){var o=getElementsByTagName((new DOMParser).parseFromString(t,"application/xml"),"Worksheet"),n=[],a=[];if(o.length){var r=getElementsByTagName(o[0],"Table");if(r.length){var l=getElementsByTagName(r[0],"Row");l.length&&(_ctor.default.arrayEach(getElementsByTagName(l[0],"Cell"),function(e){a.push(e.textContent)}),_ctor.default.arrayEach(l,function(e,t){if(t){var o={},r=getElementsByTagName(e,"Cell");_ctor.default.arrayEach(r,function(e,t){a[t]&&(o[a[t]]=e.textContent)}),n.push(o)}}))}}return{fields:a,rows:n}}function checkImportData(e,t){var o=[];return e.forEach(function(e){var t=e.property;t&&o.push(t)}),o.every(function(e){return-1<t.indexOf(e)})}function handleImport(t,e,o){var r=t.tableFullColumn,n=t._importResolve,a={fields:[],rows:[]};switch(o.type){case"csv":a=parseCsv(r,e);break;case"txt":a=parseTxt(r,e);break;case"html":a=parseHTML(r,e);break;case"xml":a=parseXML(r,e)}var l=a,i=l.fields,c=l.rows,s=checkImportData(r,i);s?(t.createData(c).then(function(e){"insert"===o.mode?t.insert(e):t.reloadData(e)}),!1!==o.message&&_vXETable.default.modal.message({message:_conf.default.i18n("vxe.table.impSuccess",[c.length]),status:"success"})):!1!==o.message&&_vXETable.default.modal.message({message:_conf.default.i18n("vxe.error.impFields"),status:"error"}),n&&(n(s),t._importResolve=null)}function afterPrintEvent(){printFrame&&printFrame.parentNode&&printFrame.parentNode.removeChild(printFrame)}function handlePrint(e,t,o){var r=t.beforePrintMethod;r&&(o=r({content:o,options:t,$table:e})||"");var n=getExportBlobByContent(o=createHtmlPage(t,o),t);if(_tools.DomTools.browse.msie){if(printFrame){try{printFrame.contentDocument.write(""),printFrame.contentDocument.clear()}catch(e){}document.body.removeChild(printFrame)}printFrame=createFrame(),document.body.appendChild(printFrame),printFrame.contentDocument.write(o),printFrame.contentDocument.execCommand("print")}else printFrame||((printFrame=createFrame()).onload=function(e){e.target.src&&(e.target.contentWindow.onafterprint=afterPrintEvent,e.target.contentWindow.print())}),printFrame.parentNode||document.body.appendChild(printFrame),printFrame.src=URL.createObjectURL(n)}var _default={methods:{_exportCsv:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["exportCsv","exportData"]),this.exportData(e)},_exportData:function(e){var n=this,t=this.$xegrid,o=this.visibleColumn,a=this.tableFullColumn,r=this.afterFullData,l=this.treeConfig,i=this.treeOpts,c=this.exportOpts,s=e&&e.columns,d=[];s&&s.length?s.forEach(function(e){var t;if(e){if(_tools.UtilTools.isColumn(e))t=e;else if(_ctor.default.isString(e))t=n.getColumnByField(e);else{var o=e.type,r=e.property||e.field;r&&o?t=a.find(function(e){return e.property===r&&e.type===o}):r?t=n.getColumnByField(r):o&&(t=a.find(function(e){return e.type===o}))}t&&d.push(t)}}):d=o;var u=Object.assign({isHeader:!0,isFooter:!0,download:!0,type:"csv",mode:"current",columnFilterMethod:s&&s.length?null:function(e){return defaultFilterExportColumn(e.column)}},c,{print:!1},e,{columns:d});if(u.filename||(u.filename=_conf.default.i18n(u.original?"vxe.table.expOriginFilename":"vxe.table.expFilename",[_ctor.default.toDateString(Date.now(),"yyyyMMddHHmmss")])),u.sheetName||(u.sheetName=document.title),-1===_vXETable.default.exportTypes.indexOf(u.type))throw new Error(_tools.UtilTools.getLog("vxe.error.notType",[u.type]));if(!u.data)if(u.data=r,"selected"===u.mode){var p=this.getCheckboxRecords();-1<["html","pdf"].indexOf(u.type)&&l?u.data=_ctor.default.searchTree(this.getTableData().fullData,function(e){return-1<p.indexOf(e)},i):u.data=p}else if("all"===u.mode&&t&&!u.remote){var f=t.proxyOpts,m=f.beforeQueryAll,h=f.afterQueryAll,b=f.ajax,v=void 0===b?{}:b,x=f.props,g=void 0===x?{}:x,y=v.queryAll;if(y){var _={$table:this,$grid:t,sort:t.sortData,filters:t.filterData,form:t.formData,target:y,options:u};return Promise.resolve((m||y)(_)).catch(function(e){return e}).then(function(e){return u.data=(g.list?_ctor.default.get(e,g.list):e)||[],h&&h(_),handleExport(n,u)})}}return handleExport(this,u)},_importByFile:function(t,e){var o=this;if(window.FileReader){var r=_tools.UtilTools.parseFile(t),n=r.type,a=r.filename,l=Object.assign({mode:"insert"},e,{type:n,filename:a});if(-1<(l.types||_vXETable.default.importTypes).indexOf(n)){if(l.remote){var i={file:t,options:l,$table:this};return l.importMethod?l.importMethod(i):Promise.resolve(i)}this.preventEvent(null,"event.import",{file:t,options:l,columns:this.tableFullColumn},function(){var e=new FileReader;e.onerror=function(){_tools.UtilTools.error("vxe.error.notType",[n])},e.onload=function(e){handleImport(o,e.target.result.trim(),l)},e.readAsText(t,"UTF-8")})}else _tools.UtilTools.error("vxe.error.notType",[n])}else _tools.UtilTools.error("vxe.error.notExp");return Promise.resolve()},_importData:function(e){var r=this,o=Object.assign({types:_vXETable.default.importTypes},this.importOpts,e),t=new Promise(function(t,o){r._importResolve=function(e){t(e),r._importResolve=null,r._importReject=null},r._importReject=function(e){o(e),r._importResolve=null,r._importReject=null}});return this.readFile(o).then(function(e){var t=e.file;r.importByFile(t,o)}).catch(function(e){r._importReject(e),r._importReject=null}),t},_saveFile:function(e){return saveLocalFile(e)},_readFile:function(){var l=this,i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};fileForm||(fileForm=document.createElement("form"),fileInput=document.createElement("input"),fileForm.className="vxe-table--file-form",fileInput.name="file",fileInput.type="file",fileForm.appendChild(fileInput),document.body.appendChild(fileForm));var c=i.types||[],s=!c.length||c.some(function(e){return"*"===e});return fileInput.multiple=!!i.multiple,fileInput.accept=s?"":".".concat(c.join(", .")),fileInput.onchange=function(e){var t,o=e.target.files,r=o[0];if(!s)for(var n=0;n<o.length;n++){var a=_tools.UtilTools.parseFile(o[n]).type;if(!_ctor.default.includes(c,a)){t=a;break}}t?(!1!==i.message&&_vXETable.default.modal.message({message:_ctor.default.template(_conf.default.i18n("vxe.error.notType"),[t]),status:"error"}),l._fileReject({files:o,file:r})):l._fileResolve({files:o,file:r,target:e.target}),l._fileResolve=null},fileForm.reset(),fileInput.click(),new Promise(function(e,t){l._fileResolve=e,l._fileReject=t})},_print:function(e){var o=this,r=Object.assign({original:!1},this.printOpts,e,{type:"html",download:!1,remote:!1,print:!0});r.sheetName||(r.sheetName=document.title),r.content?handlePrint(this,r,r.content):this.exportData(r).then(function(e){var t=e.content;handlePrint(o,r,t)})},_openImport:function(e){var t=Object.assign({mode:"insert",message:!0},e,this.importOpts),o=t.types||_vXETable.default.exportTypes;if(!!this.getTreeStatus())t.message&&_vXETable.default.modal.message({message:_conf.default.i18n("vxe.error.treeNotImp"),status:"error"});else{this.importConfig||_tools.UtilTools.error("vxe.error.reqProp",["import-config"]);var r=o.map(function(e){return{value:e,label:"vxe.export.types.".concat(e)}}),n=t.modes.map(function(e){return{value:e,label:"vxe.import.modes.".concat(e)}});Object.assign(this.importStore,{file:null,type:"",filename:"",modeList:n,typeList:r,visible:!0}),Object.assign(this.importParams,t)}},_openExport:function(e){var t=this.$toolbar,o=this.exportConfig,r=this.customOpts,n=this.exportOpts,a=this.collectColumn,l=this.footerTableData,i=this.getCheckboxRecords(),c=!!l.length,s=Object.assign({message:!0,isHeader:!0},n,e),d=s.types||_vXETable.default.exportTypes,u=r.checkMethod||(t?t.customOpts.checkMethod:null),p=a.slice(0),f=s.columns;o||_tools.UtilTools.error("vxe.error.reqProp",["export-config"]);var m=d.map(function(e){return{value:e,label:"vxe.export.types.".concat(e)}}),h=s.modes.map(function(e){return{value:e,label:"vxe.export.modes.".concat(e)}});return _ctor.default.eachTree(p,function(n,e,t,o,r){(n.children&&n.children.length||defaultFilterExportColumn(n))&&(n.checked=f?f.some(function(e){if(_tools.UtilTools.isColumn(e))return n===e;if(_ctor.default.isString(e))return n.field===e;var t=e.id,o=e.type,r=e.property||e.field;return t?n.id===t:r&&o?n.property===r&&n.type===o:r?n.property===r:o?n.type===o:void 0}):n.visible,n.halfChecked=!1,n.disabled=r&&r.disabled||!!u&&!u({column:n}))}),Object.assign(this.exportStore,{columns:p,typeList:m,modeList:h,hasFooter:c,visible:!0}),Object.assign(this.exportParams,{filename:s.filename||"",sheetName:s.sheetName||"",type:s.type||m[0].value,mode:i.length?"selected":"current",original:s.original,message:s.message,isHeader:s.isHeader,isFooter:c&&(!_ctor.default.isBoolean(n.isFooter)||n.isFooter),isPrint:s.isPrint}),this.$nextTick()}}};exports.default=_default;