"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ctor=_interopRequireDefault(require("xe-utils/ctor")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var browse=_tools.DomTools.browse;function getTargetOffset(e,o){var t=0,l=0,n=!browse.firefox&&_tools.DomTools.hasClass(e,"vxe-checkbox--label");if(n){var s=getComputedStyle(e);t-=_ctor.default.toNumber(s.paddingTop),l-=_ctor.default.toNumber(s.paddingLeft)}for(;e&&e!==o;)if(t+=e.offsetTop,l+=e.offsetLeft,e=e.offsetParent,n){var c=getComputedStyle(e);t-=_ctor.default.toNumber(c.paddingTop),l-=_ctor.default.toNumber(c.paddingLeft)}return{offsetTop:t,offsetLeft:l}}function getCheckboxRangeRows(e,o,t,l){var n=0,s=[],c=0<l,r=0<l?l:Math.abs(l)+t.offsetHeight,d=e.afterFullData,a=e.scrollYStore;if(e.scrollYLoad){var i=e.getVTRowIndex(o.row);s=c?d.slice(i,i+Math.ceil(r/a.rowHeight)):d.slice(i-Math.floor(r/a.rowHeight)+1,i+1)}else for(var h=c?"next":"previous";t&&n<r;)s.push(e.getRowNode(t).item),n+=t.offsetHeight,t=t["".concat(h,"ElementSibling")];return s}var _default={methods:{moveTabSelected:function(e,o,t){var l,n,s,c,r=this,d=this.afterFullData,a=this.visibleColumn,i=this.editConfig,h=this.editOpts,u=this.isSeqColumn,f=Object.assign({},e),m=d.indexOf(f.row),g=a.indexOf(f.column);if(t.preventDefault(),o){for(var C=g-1;0<=C;C--)if(!u(a[C])){s=a[c=C];break}if(!s&&0<m){l=d[n=m-1];for(var x=a.length-1;0<=x;x--)if(!u(a[x])){s=a[c=x];break}}}else{for(var p=g+1;p<a.length;p++)if(!u(a[p])){s=a[c=p];break}if(!s&&m<d.length-1){l=d[n=m+1];for(var v=0;v<a.length;v++)if(!u(a[v])){s=a[c=v];break}}}s&&(l?(f.rowIndex=n,f.row=l):f.rowIndex=m,f.columnIndex=c,f.column=s,f.cell=this.getCell(f.row,f.column),i&&("click"!==h.trigger&&"dblclick"!==h.trigger||("row"===h.mode?this.handleActived(f,t):this.scrollToRow(f.row,f.column).then(function(){return r.handleSelected(f,t)}))))},moveCurrentRow:function(e,o,t){var l,n=this,s=this.currentRow,c=this.treeConfig,r=this.treeOpts,d=this.afterFullData;if(t.preventDefault(),s)if(c){var a=_ctor.default.findTree(d,function(e){return e===s},r),i=a.index,h=a.items;e&&0<i?l=h[i-1]:o&&i<h.length-1&&(l=h[i+1])}else{var u=this.getVTRowIndex(s);e&&0<u?l=d[u-1]:o&&u<d.length-1&&(l=d[u+1])}else l=d[0];if(l){var f={$table:this,row:l};this.scrollToRow(l).then(function(){return n.triggerCurrentRowEvent(t,f)})}},moveSelected:function(e,o,t,l,n,s){var c=this,r=this.afterFullData,d=this.visibleColumn,a=this.isSeqColumn,i=Object.assign({},e),h=this.getVTRowIndex(i.row),u=this.getVTColumnIndex(i.column);if(s.preventDefault(),t&&0<h)i.rowIndex=h-1,i.row=r[i.rowIndex];else if(n&&h<r.length-1)i.rowIndex=h+1,i.row=r[i.rowIndex];else if(o&&u){for(var f=u-1;0<=f;f--)if(!a(d[f])){i.columnIndex=f,i.column=d[f];break}}else if(l)for(var m=u+1;m<d.length;m++)if(!a(d[m])){i.columnIndex=m,i.column=d[m];break}this.scrollToRow(i.row,i.column).then(function(){i.cell=c.getCell(i.row,i.column),c.handleSelected(i,s)})},triggerHeaderCellMousedownEvent:function(e,o){var t=this.mouseConfig,l=this.mouseOpts,n=e.currentTarget,s=_tools.DomTools.getEventTargetNode(e,n,"vxe-cell--sort").flag,c=_tools.DomTools.getEventTargetNode(e,n,"vxe-cell--filter").flag;t&&l.area&&this.handleHeaderCellAreaEvent?this.handleHeaderCellAreaEvent(e,Object.assign({cell:n,triggerSort:s,triggerFilter:c},o)):t&&l.checked&&this.handleHeaderCellCheckedEvent(e,Object.assign({cell:n,triggerSort:s,triggerFilter:c},o)),this.focus(),this.closeMenu()},triggerCellMousedownEvent:function(e,o){var t=e.currentTarget;o.cell=t,this.handleCellMousedownEvent(e,o),this.focus(),this.closeFilter(),this.closeMenu()},handleCellMousedownEvent:function(e,o){var t=this.mouseConfig,l=this.mouseOpts,n=this.checkboxConfig,s=this.checkboxOpts,c=this.editConfig,r=this.editOpts,d=o.column;t&&l.area&&this.handleCellAreaEvent?this.handleCellAreaEvent(e,o):t&&l.checked?this.handleCheckedRangeEvent(e,o):(n&&s.range&&this.handleCheckboxRangeEvent(e,o),t&&l.selected&&("seq"===d.type||"index"===d.type||c&&"cell"!==r.mode||this.handleSelected(o,e)))},handleHeaderCellCheckedEvent:function(e,o){var d=this.$el,t=this.tableData,l=this.mouseConfig,n=this.mouseOpts,s=this.elemStore,a=this.handleChecked,i=this.handleHeaderChecked,c=e.button,r=o.column,h=e.currentTarget,u=0===c,f="seq"===r.type||"index"===r.type;if(l&&n.checked){var m=s["main-header-list"].children,g=s["main-body-list"].children;if(f)this.handleAllChecked(e);else{this.clearSelected(e),this.clearHeaderChecked(),this.clearIndexChecked();var C=g[0].querySelector(".".concat(r.id));if(u){var x=document.onmousemove,p=document.onmouseup,v=_ctor.default.throttle(function(e){var o=_tools.DomTools.getEventTargetNode(e,d,"vxe-header--column"),t=o.flag,l=o.targetElem;if(!t){var n=_tools.DomTools.getEventTargetNode(e,d,"vxe-body--column");t=n.flag,l=n.targetElem}if(t&&!_tools.DomTools.hasClass(l,"col--seq")){var s=[].indexOf.call(l.parentNode.children,l),c=g[g.length-1].children[s],r=m[0].children[s];i(_tools.DomTools.getRowNodes(m,_tools.DomTools.getCellNodeIndex(r),_tools.DomTools.getCellNodeIndex(h))),a(_tools.DomTools.getRowNodes(g,_tools.DomTools.getCellNodeIndex(C),_tools.DomTools.getCellNodeIndex(c)))}},80,{leading:!0,trailing:!0});_tools.DomTools.addClass(d,"c--checked"),document.onmousemove=function(e){e.preventDefault(),e.stopPropagation(),v(e)},document.onmouseup=function(){_tools.DomTools.removeClass(d,"c--checked"),document.onmousemove=x,document.onmouseup=p}}if(i([[h]]),g.length){var _=g[g.length-1].querySelector(".".concat(r.id)),T=g[0],y=g[g.length-1],k=T.querySelector(".col--seq");o.rowIndex=0,o.row=t[0],o.cell=this.getCell(o.row,o.column),this.handleSelected(o,e),this.handleIndexChecked(_tools.DomTools.getRowNodes(g,_tools.DomTools.getCellNodeIndex(k),_tools.DomTools.getCellNodeIndex(y.querySelector(".col--seq")))),this.handleChecked(_tools.DomTools.getRowNodes(g,_tools.DomTools.getCellNodeIndex(C),_tools.DomTools.getCellNodeIndex(_)))}}}},getCheckboxRangeRows:function(e,o){for(var t=0,l=[],n=0<o?"next":"previous",s=0<o?o:Math.abs(o)+e.offsetHeight;e&&t<s;)l.push(this.getRowNode(e).item),t+=e.offsetHeight,e=e["".concat(n,"ElementSibling")];return l},handleCheckedRangeEvent:function(e,o){var d=this,a=this.$el,t=this.visibleColumn,l=this.editStore,n=this.mouseOpts,s=this.elemStore,c=l.checked,r=o.column,i=e.button,h=e.currentTarget,u=0===i,f="seq"===r.type||"index"===r.type;this.clearHeaderChecked(),this.clearIndexChecked();var m=s["main-body-list"].children,g=s["main-header-list"].children,C=h.parentNode.lastElementChild,x=h.parentNode.firstElementChild;if(u){var p=document.onmousemove,v=document.onmouseup,_=_tools.DomTools.getCellNodeIndex(h),T=[].indexOf.call(h.parentNode.children,h),y=g[0].children[T],k=_ctor.default.throttle(function(e){var o=_tools.DomTools.getEventTargetNode(e,a,"vxe-body--column"),t=o.flag,l=o.targetElem;if(t)if(f){var n=l.parentNode.firstElementChild;d.handleChecked(_tools.DomTools.getRowNodes(m,_tools.DomTools.getCellNodeIndex(n.nextElementSibling),_tools.DomTools.getCellNodeIndex(C))),d.handleIndexChecked(_tools.DomTools.getRowNodes(m,_tools.DomTools.getCellNodeIndex(n),_tools.DomTools.getCellNodeIndex(h)))}else if(!_tools.DomTools.hasClass(l,"col--seq")){var s=l.parentNode.firstElementChild,c=[].indexOf.call(l.parentNode.children,l),r=g[0].children[c];d.handleHeaderChecked(_tools.DomTools.getRowNodes(g,_tools.DomTools.getCellNodeIndex(r),_tools.DomTools.getCellNodeIndex(y))),d.handleIndexChecked(_tools.DomTools.getRowNodes(m,_tools.DomTools.getCellNodeIndex(s),_tools.DomTools.getCellNodeIndex(x))),d.handleChecked(_tools.DomTools.getRowNodes(m,_,_tools.DomTools.getCellNodeIndex(l)))}},80,{leading:!0,trailing:!0});document.onmousemove=function(e){e.preventDefault(),e.stopPropagation(),k(e)},document.onmouseup=function(){document.onmousemove=p,document.onmouseup=v}}if(f){var b=h.parentNode.firstElementChild;o.columnIndex++,o.column=t[o.columnIndex],o.cell=h.nextElementSibling,this.handleSelected(o,e),this.handleChecked(_tools.DomTools.getRowNodes(m,_tools.DomTools.getCellNodeIndex(b.nextElementSibling),_tools.DomTools.getCellNodeIndex(C))),this.handleHeaderChecked([g[0].querySelectorAll(".vxe-header--column:not(.col--seq)")]),this.handleIndexChecked(_tools.DomTools.getRowNodes(m,_tools.DomTools.getCellNodeIndex(b),_tools.DomTools.getCellNodeIndex(h)))}else if(u){var w=h.parentNode.firstElementChild;this.handleSelected(o,e),this.handleHeaderChecked([[g[0].querySelector(".".concat(r.id))]]),this.handleIndexChecked([[w]])}else n.selected&&(c.rowNodes&&c.rowNodes.some(function(e){return-1<e.indexOf(h)})||this.handleSelected(o,e))},handleCheckboxRangeEvent:function(e,i){var h=this,o=i.column,t=i.cell;if(0===e.button&&-1<["checkbox","selection"].indexOf(o.type)){var l=this.$el,n=this.elemStore,u=e.clientX,f=e.clientY,m=n["".concat(o.fixed||"main","-body-wrapper")]||n["main-body-wrapper"],g=m.querySelector(".vxe-table--checkbox-range"),s=document.onmousemove,c=document.onmouseup,C=t.parentNode,x=this.getCheckboxRecords(),p=[],r=getTargetOffset(e.target,m),v=r.offsetTop+e.offsetY,_=r.offsetLeft+e.offsetX,T=m.scrollTop,d=C.offsetHeight,a=null,y=!1,k=1,b=function(e,o){h.emitEvent("checkbox-range-".concat(e),{records:h.getCheckboxRecords(),reserves:h.getCheckboxReserveRecords()},o)},w=function(e){var o=e.clientX,t=e.clientY,l=o-u,n=t-f+(m.scrollTop-T),s=Math.abs(n),c=Math.abs(l),r=v,d=_;n<1?(r+=n)<1&&(r=1,s=v):s=Math.min(s,m.scrollHeight-v-1),l<1?(d+=l,_<c&&(d=1,c=_)):c=Math.min(c,m.clientWidth-_-1),g.style.height="".concat(s,"px"),g.style.width="".concat(c,"px"),g.style.left="".concat(d,"px"),g.style.top="".concat(r,"px"),g.style.display="block";var a=getCheckboxRangeRows(h,i,C,n<1?-s:s);10<s&&a.length!==p.length&&(p=a,e.ctrlKey?a.forEach(function(e){h.handleSelectRow({row:e},-1===x.indexOf(e))}):(h.setAllCheckboxRow(!1),h.setCheckboxRow(a,!0)),b("change",e))},D=function(){clearTimeout(a),a=null},N=function s(c){D(),a=setTimeout(function(){if(a){var e=m.scrollLeft,o=m.scrollTop,t=m.clientHeight,l=m.scrollHeight,n=Math.ceil(50*k/d);y?o+t<l?(h.scrollTo(e,o+n),s(c),w(c)):D():o?(h.scrollTo(e,o-n),s(c),w(c)):D()}},50)};_tools.DomTools.addClass(l,"drag--area"),document.onmousemove=function(e){e.preventDefault(),e.stopPropagation();var o=e.clientY,t=_tools.DomTools.getAbsolutePos(m).boundingTop;o<t?(y=!1,k=t-o,a||N(e)):o>t+m.clientHeight?(y=!0,k=o-t-m.clientHeight,a||N(e)):a&&D(),w(e)},document.onmouseup=function(e){D(),_tools.DomTools.removeClass(l,"drag--area"),g.removeAttribute("style"),document.onmousemove=s,document.onmouseup=c,b("end",e)},b("start",e)}},_clearChecked:function(){var e=this.$refs,o=this.editStore,t=this.mouseConfig,l=this.mouseOpts,n=o.checked;if(t&&l.checked){var s=e.tableBody;n.rows=[],n.columns=[],n.tRows=[],n.tColumns=[],s.$refs.checkBorders.style.display="none",_ctor.default.arrayEach(s.$el.querySelectorAll(".col--checked"),function(e){return _tools.DomTools.removeClass(e,"col--checked")})}return this.$nextTick()},_getMouseSelecteds:function(){return _tools.UtilTools.warn("vxe.error.delFunc",["getMouseSelecteds","getSelectedCell"]),this.getSelectedCell()},_getMouseCheckeds:function(){return this.getSelectedRanges()},_getSelectedCell:function(){var e=this.editStore.selected,o=e.args,t=e.column;return o&&t?Object.assign({},o):null},_getSelectedRanges:function(){var o=this,e=this.editStore.checked.rowNodes,t=void 0===e?[]:e,l=[],n=[];return t&&t.length&&(n=t.map(function(e){return o.getRowNode(e[0].parentNode).item}),l=t[0].map(function(e){return o.getColumnNode(e).item})),{columns:l,rows:n,rowNodes:t}},handleChecked:function(e){var o=this.editStore.checked;this.clearChecked();var n=-2,s=-2,c=0,r=0;_ctor.default.arrayEach(e,function(e,o){var l=0===o;_ctor.default.arrayEach(e,function(e,o){var t=0===o;t&&l&&(c=e.offsetTop,r=e.offsetLeft),l&&(n+=e.offsetWidth),t&&(s+=e.offsetHeight),_tools.DomTools.addClass(e,"col--checked")})});var t=this.$refs.tableBody.$refs,l=t.checkBorders,d=t.checkTop,a=t.checkRight,i=t.checkBottom,h=t.checkLeft;l.style.display="block",Object.assign(d.style,{top:"".concat(c,"px"),left:"".concat(r,"px"),width:"".concat(n,"px")}),Object.assign(a.style,{top:"".concat(c,"px"),left:"".concat(r+n,"px"),height:"".concat(s,"px")}),Object.assign(i.style,{top:"".concat(c+s,"px"),left:"".concat(r,"px"),width:"".concat(n,"px")}),Object.assign(h.style,{top:"".concat(c,"px"),left:"".concat(r,"px"),height:"".concat(s,"px")}),o.rowNodes=e},handleAllChecked:function(e){var o=this.tableData,t=this.visibleColumn,l=this.mouseConfig,n=this.mouseOpts,s=this.elemStore;if(l&&n.checked){e.preventDefault();var c=s["main-header-list"],r=c.children,d=s["main-body-list"].children,a=_ctor.default.find(t,function(e){return"seq"===e.type||"index"===e.type})||t[0],i=c.querySelector(".".concat(a.id)),h=d[0],u=d[d.length-1],f=h.querySelector(".".concat(a.id)),m={$table:this,rowIndex:0,row:o[0],column:_ctor.default.find(t,function(e){return e.property})};m.columnIndex=this.getColumnIndex(m.column),m.cell=this.getCell(m.row,m.column),this.handleSelected(m,e),this.handleHeaderChecked(_tools.DomTools.getRowNodes(r,_tools.DomTools.getCellNodeIndex(i.nextElementSibling),_tools.DomTools.getCellNodeIndex(i.parentNode.lastElementChild))),this.handleIndexChecked(_tools.DomTools.getRowNodes(d,_tools.DomTools.getCellNodeIndex(f),_tools.DomTools.getCellNodeIndex(u.querySelector(".".concat(a.id))))),this.handleChecked(_tools.DomTools.getRowNodes(d,_tools.DomTools.getCellNodeIndex(f.nextElementSibling),_tools.DomTools.getCellNodeIndex(u.lastElementChild)))}},handleIndexChecked:function(e){var o=this.editStore.indexs;this.clearIndexChecked(),_ctor.default.arrayEach(e,function(e){_ctor.default.arrayEach(e,function(e){_tools.DomTools.addClass(e,"col--seq-checked")})}),o.rowNodes=e},_clearIndexChecked:function(){var e=this.elemStore["main-body-list"];return _ctor.default.arrayEach(e.querySelectorAll(".col--seq-checked"),function(e){return _tools.DomTools.removeClass(e,"col--seq-checked")}),this.$nextTick()},handleHeaderChecked:function(e){var o=this.editStore.titles;this.clearHeaderChecked(),_ctor.default.arrayEach(e,function(e){_ctor.default.arrayEach(e,function(e){_tools.DomTools.addClass(e,"col--title-checked")})}),o.rowNodes=e},_clearHeaderChecked:function(){var e=this.elemStore["main-header-list"];return e&&_ctor.default.arrayEach(e.querySelectorAll(".col--title-checked"),function(e){return _tools.DomTools.removeClass(e,"col--title-checked")}),this.$nextTick()},_clearCopyed:function(){var e=this.$refs,o=this.editStore,t=this.keyboardConfig,l=o.copyed;if(t&&t.isCut){var n=e.tableBody,s=e.tableBody.$refs.copyBorders;l.cut=!1,l.rows=[],l.columns=[],s.style.display="none",_ctor.default.arrayEach(n.$el.querySelectorAll(".col--copyed"),function(e){return _tools.DomTools.removeClass(e,"col--copyed")})}return this.$nextTick()},handleCopyed:function(e){var o=this.tableData,t=this.tableColumn,l=this.editStore,n=l.copyed,s=l.checked.rowNodes;this.clearCopyed();var c=-3,r=-3,d=0,a=0,i=[],h=[];if(s.length){var u=s[0],f=_tools.DomTools.getCellNodeIndex(u[0]),m=f.rowIndex,g=f.columnIndex;i=t.slice(g,g+u.length),h=o.slice(m,m+s.length)}_ctor.default.arrayEach(s,function(e,o){var l=0===o;_ctor.default.arrayEach(e,function(e,o){var t=0===o;t&&l&&(d=e.offsetTop,a=e.offsetLeft),l&&(c+=e.offsetWidth),t&&(r+=e.offsetHeight),_tools.DomTools.addClass(e,"col--copyed")})});var C=this.$refs.tableBody.$refs,x=C.copyBorders,p=C.copyTop,v=C.copyRight,_=C.copyBottom,T=C.copyLeft;x.style.display="block",Object.assign(p.style,{top:"".concat(d,"px"),left:"".concat(a,"px"),width:"".concat(c,"px")}),Object.assign(v.style,{top:"".concat(d,"px"),left:"".concat(a+c,"px"),height:"".concat(r,"px")}),Object.assign(_.style,{top:"".concat(d+r,"px"),left:"".concat(a,"px"),width:"".concat(c,"px")}),Object.assign(T.style,{top:"".concat(d,"px"),left:"".concat(a,"px"),height:"".concat(r,"px")}),n.cut=e,n.rows=h,n.columns=i,n.rowNodes=s},handlePaste:function(){var o=this.tableData,s=this.visibleColumn,e=this.editStore,t=this.elemStore,l=e.copyed,n=e.selected,c=l.cut,r=l.rows,d=l.columns;if(r.length&&d.length&&n.row&&n.column){var a=n.args,i=a.rowIndex,h=a.columnIndex;_ctor.default.arrayEach(r,function(l,e){var n=o[i+e];n&&_ctor.default.arrayEach(d,function(e,o){var t=s[h+o];t&&_tools.UtilTools.setCellValue(n,t,_tools.UtilTools.getCellValue(l,e)),c&&_tools.UtilTools.setCellValue(l,e,null)})}),c&&this.clearCopyed();var u=t["main-body-list"].children,f=n.args.cell,m=f.parentNode,g=_ctor.default.arrayIndexOf(m.children,f),C=u[_ctor.default.arrayIndexOf(u,m)+r.length-1].children[g+d.length-1];this.handleChecked(_tools.DomTools.getRowNodes(u,_tools.DomTools.getCellNodeIndex(f),_tools.DomTools.getCellNodeIndex(C)))}}}};exports.default=_default;