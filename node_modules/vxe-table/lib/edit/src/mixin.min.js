"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ctor=_interopRequireDefault(require("xe-utils/ctor")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,o=new Array(t);r<t;r++)o[r]=e[r];return o}var _default={methods:{_insert:function(e){return this.insertAt(e)},_insertAt:function(e,t){var r,o=this,l=this.mergeList,i=this.afterFullData,n=this.editStore,s=this.sYOpts,a=this.scrollYLoad,c=this.tableFullData,u=this.treeConfig;_ctor.default.isArray(e)||(e=[e]);var d=e.map(function(e){return o.defineField(Object.assign({},e))});if(t)if(-1===t)i.push.apply(i,_toConsumableArray(d)),c.push.apply(c,_toConsumableArray(d)),l.forEach(function(e){var t=e.row,r=e.rowspan;t+r>i.length&&(e.rowspan=r+d.length)});else{if(u)throw new Error(_tools.UtilTools.getLog("vxe.error.noTree",["insert"]));var h=i.indexOf(t);if(-1===h)throw new Error(_tools.UtilTools.error("vxe.error.unableInsert"));i.splice.apply(i,_toConsumableArray([h,0].concat(d))),c.splice.apply(c,_toConsumableArray([c.indexOf(t),0].concat(d))),l.forEach(function(e){var t=e.row,r=e.rowspan;h<t?e.row=t+d.length:h<t+r&&(e.rowspan=r+d.length)})}else i.unshift.apply(i,_toConsumableArray(d)),c.unshift.apply(c,_toConsumableArray(d)),l.forEach(function(e){var t=e.row;0<t&&(e.row=t+d.length)});return(r=n.insertList).unshift.apply(r,_toConsumableArray(d)),this.scrollYLoad=!u&&-1<s.gt&&s.gt<c.length,this.handleTableData(),this.updateFooter(),this.updateCache(),this.checkSelectionStatus(),a&&this.updateScrollYSpace(),this.$nextTick().then(function(){return o.recalculate(),o.updateCellAreas(),{row:d.length?d[d.length-1]:null,rows:d}})},_remove:function(e){var t=this,l=this.afterFullData,i=this.tableFullData,r=this.treeConfig,n=this.mergeList,o=this.editStore,s=this.checkboxOpts,a=this.selection,c=this.isInsertByRow,u=this.sYOpts,d=this.scrollYLoad,h=o.actived,f=o.removeList,v=o.insertList,m=s.checkField,C=[];return e?_ctor.default.isArray(e)||(e=[e]):e=i,e.forEach(function(e){c(e)||f.push(e)}),m||e.forEach(function(e){var t=a.indexOf(e);-1<t&&a.splice(t,1)}),i===e?(e=C=i.slice(0),this.tableFullData=[],this.afterFullData=[],this.clearMergeCells()):e.forEach(function(e){var t=i.indexOf(e);if(-1<t){var r=i.splice(t,1);C.push(r[0])}var o=l.indexOf(e);-1<o&&(n.forEach(function(e){var t=e.row,r=e.rowspan;o<t?e.row=t-1:o<t+r&&(e.rowspan=r-1)}),l.splice(o,1))}),h.row&&-1<e.indexOf(h.row)&&this.clearActived(),e.forEach(function(e){var t=v.indexOf(e);-1<t&&v.splice(t,1)}),this.scrollYLoad=!r&&-1<u.gt&&u.gt<i.length,this.handleTableData(),this.updateFooter(),this.updateCache(),this.checkSelectionStatus(),d&&this.updateScrollYSpace(),this.$nextTick().then(function(){return t.recalculate(),t.updateCellAreas(),{row:C.length?C[C.length-1]:null,rows:C}})},_removeSelecteds:function(){return _tools.UtilTools.warn("vxe.error.delFunc",["removeSelecteds","removeCheckboxRow"]),this.removeCheckboxRow()},_removeCheckboxRow:function(){var t=this;return this.remove(this.getCheckboxRecords()).then(function(e){return t.clearCheckboxRow(),e})},_removeRadioRow:function(){var t=this,e=this.getRadioRecord();return this.remove(e||[]).then(function(e){return t.clearRadioRow(),e})},_removeCurrentRow:function(){var t=this,e=this.getCurrentRecord();return this.remove(e||[]).then(function(e){return t.clearCurrentRow(),e})},_getRecordset:function(){return{insertRecords:this.getInsertRecords(),removeRecords:this.getRemoveRecords(),updateRecords:this.getUpdateRecords()}},_getInsertRecords:function(){var t=this.editStore.insertList,r=[];return t.length&&this.tableFullData.forEach(function(e){-1<t.indexOf(e)&&r.push(e)}),r},_getRemoveRecords:function(){return this.editStore.removeList},_getUpdateRecords:function(){var e=this.keepSource,t=this.tableFullData,r=this.isUpdateByRow,o=this.treeConfig,l=this.treeOpts,i=this.editStore;if(e||_tools.UtilTools.warn("vxe.error.reqProp",["keep-source"]),e){var n=i.actived,s=n.row,a=n.column;return(s||a)&&this._syncActivedCell(),o?_ctor.default.filterTree(t,function(e){return r(e)},l):t.filter(function(e){return r(e)})}return[]},handleActived:function(e,t){var r=this,o=this.editStore,l=this.editOpts,i=this.tableColumn,n=this.mouseConfig,s=l.mode,a=l.activeMethod,c=o.actived,u=e.row,d=e.column,h=d.editRender,f=e.cell=e.cell||this.getCell(u,d);if(_tools.UtilTools.isEnableConf(h)&&f){if(c.row!==u||"cell"===s&&c.column!==d){var v="edit-disabled";a&&!a(e)||(n&&(this.clearCopyed(t),this.clearChecked(),this.clearSelected(t),this.clearCellAreas(t),this.clearCopyCellArea(t)),this.closeTooltip(),this.clearActived(t),v="edit-actived",d.renderHeight=f.offsetHeight,c.args=e,c.row=u,c.column=d,"row"===s?i.forEach(function(e){return r._getColumnModel(u,e)}):this._getColumnModel(u,d),this.$nextTick(function(){r.handleFocus(e,t)})),this.emitEvent(v,Object.assign({},e,{row:u,rowIndex:this.getRowIndex(u),$rowIndex:this.getVMRowIndex(u),column:d,columnIndex:this.getColumnIndex(d),$columnIndex:this.getVMColumnIndex(d)}),t)}else{var m=c.column;if(n&&(this.clearCopyed(t),this.clearChecked(),this.clearSelected(t),this.clearCellAreas(t),this.clearCopyCellArea(t)),m!==d){var C=m.model;C.update&&_tools.UtilTools.setCellValue(u,m,C.value),this.clearValidate()}d.renderHeight=f.offsetHeight,c.args=e,c.column=d,setTimeout(function(){r.handleFocus(e,t)})}this.focus()}return this.$nextTick()},_getColumnModel:function(e,t){var r=t.model;t.editRender&&(r.value=_tools.UtilTools.getCellValue(e,t),r.update=!1)},_setColumnModel:function(e,t){var r=t.model;t.editRender&&r.update&&(_tools.UtilTools.setCellValue(e,t,r.value),r.update=!1,r.value=null)},_syncActivedCell:function(){var t=this,e=this.tableColumn,r=this.editStore,o=this.editOpts,l=r.actived,i=l.row,n=l.column;(i||n)&&("row"===o.mode?e.forEach(function(e){return t._setColumnModel(i,e)}):this._setColumnModel(i,n))},_clearActived:function(e){var t=this.editStore.actived,r=t.args,o=t.row,l=t.column;return(o||l)&&(this._syncActivedCell(),t.args=null,t.row=null,t.column=null,this.updateFooter(),this.emitEvent("edit-closed",Object.assign({},r,{row:o,rowIndex:this.getRowIndex(o),$rowIndex:this.getVMRowIndex(o),column:l,columnIndex:this.getColumnIndex(l),$columnIndex:this.getVMColumnIndex(l)}),e)),(_vXETable.default._valid?this.clearValidate():this.$nextTick()).then(this.recalculate)},_getActiveRow:function(){return _tools.UtilTools.warn("vxe.error.delFunc",["getActiveRow","getActiveRecord"]),this.getActiveRecord()},_getActiveRecord:function(){var e=this.$el,t=this.editStore,r=this.afterFullData,o=t.actived,l=o.args,i=o.row;return l&&-1<r.indexOf(i)&&e.querySelectorAll(".vxe-body--column.col--actived").length?Object.assign({},l):null},_hasActiveRow:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["hasActiveRow","isActiveByRow"]),this.isActiveByRow(e)},_isActiveByRow:function(e){return this.editStore.actived.row===e},handleFocus:function(e){var t=e.row,r=e.column,o=e.cell,l=r.editRender;if(_tools.UtilTools.isEnableConf(l)){var i,n=_vXETable.default.renderer.get(l.name),s=l.autofocus,a=l.autoselect;if(s&&(i=o.querySelector(s)),!i&&n&&n.autofocus&&(i=o.querySelector(n.autofocus)),i){if(i.focus(),a)i.select();else if(_tools.DomTools.browse.msie){var c=i.createTextRange();c.collapse(!1),c.select()}}else this.scrollToRow(t,r)}},_setActiveRow:function(e){return this.setActiveCell(e,_ctor.default.find(this.visibleColumn,function(e){return _tools.UtilTools.isEnableConf(e.editRender)}))},_setActiveCell:function(t,e){var r=this,o=_ctor.default.isString(e)?this.getColumnByField(e):e;return t&&o&&_tools.UtilTools.isEnableConf(o.editRender)?this.scrollToRow(t,!0).then(function(){var e=r.getCell(t,o);e&&(r.handleActived({row:t,rowIndex:r.getRowIndex(t),column:o,columnIndex:r.getColumnIndex(o),cell:e,$table:r}),r.lastCallTime=Date.now())}):this.$nextTick()},_setSelectCell:function(e,t){var r=this.tableData,o=this.editOpts,l=this.visibleColumn,i=_ctor.default.isString(t)?this.getColumnByField(t):t;if(e&&i&&"manual"!==o.trigger){var n=r.indexOf(e);if(-1<n&&i){var s=this.getCell(e,i),a={row:e,rowIndex:n,column:i,columnIndex:l.indexOf(i),cell:s};this.handleSelected(a,{})}}return this.$nextTick()},handleSelected:function(t,r){var o=this,e=this.mouseConfig,l=this.mouseOpts,i=this.editOpts,n=this.editStore,s=this.elemStore,a=n.actived,c=n.selected,u=t.row,d=t.column,h=t.cell,f=e&&l.selected,v=e&&l.checked;return function(){if((f||v)&&(c.row!==u||c.column!==d)&&(a.row!==u||"cell"===i.mode&&a.column!==d)){if(o.keyboardConfig&&(o.clearChecked(r),o.clearIndexChecked(),o.clearHeaderChecked()),o.clearActived(r),o.clearSelected(r),o.clearCellAreas(r),o.clearCopyCellArea(r),c.args=t,c.row=u,c.column=d,f&&o.addColSdCls(),v){var e=s["main-header-list"];o.handleChecked([[h]]),e&&o.handleHeaderChecked([[e.querySelector(".".concat(d.id))]]),o.handleIndexChecked([[h.parentNode.querySelector(".col--seq")]])}o.focus(),r&&o.emitEvent("cell-selected",t,r)}return o.$nextTick()}()},_clearSelected:function(){var e=this.editStore.selected;return e.row=null,e.column=null,this.reColTitleSdCls(),this.reColSdCls(),this.$nextTick()},reColTitleSdCls:function(){var e=this.elemStore["main-header-list"];e&&_ctor.default.arrayEach(e.querySelectorAll(".col--title-selected"),function(e){return _tools.DomTools.removeClass(e,"col--title-selected")})},reColSdCls:function(){var e=this.$el.querySelector(".col--selected");e&&_tools.DomTools.removeClass(e,"col--selected")},addColSdCls:function(){var e=this.editStore.selected,t=e.row,r=e.column;if(this.reColSdCls(),t&&r){var o=this.getCell(t,r);o&&_tools.DomTools.addClass(o,"col--selected")}}}};exports.default=_default;